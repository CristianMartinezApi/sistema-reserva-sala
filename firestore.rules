rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Verifica se o email é do domínio @pge.sc.gov.br
    function isPgeEmail() {
      return request.auth != null &&
             request.auth.token.email != null &&
             (request.auth.token.email.matches('.*@pge\\.sc\\.gov\\.br$') ||
              request.auth.token.email == 'fernandesribe04@gmail.com'); // DEV: remover em produção
    }
    
    // Regras para a coleção de reservas
    match /reservas/{reservaId} {
      
      // Apenas usuários autenticados do domínio PGE podem LER (para verificar disponibilidade)
      allow read: if isPgeEmail();
      
      // Criar: autenticado + domínio PGE + validação de campos
      allow create: if isPgeEmail()
        && request.resource.data.keys().hasAll(['responsavel', 'responsavelEmail', 'data', 'horaInicio', 'horaFim', 'assunto', 'criadaEm'])
        && request.resource.data.responsavelEmail == request.auth.token.email
        && request.resource.data.assunto is string
        && request.resource.data.assunto.size() >= 3 
        && request.resource.data.assunto.size() <= 200
        && request.resource.data.horaInicio is string
        && request.resource.data.horaFim is string
        && request.resource.data.horaInicio < request.resource.data.horaFim;
      
      // Delete: autenticado + domínio PGE + dono da reserva (por email)
      allow delete: if isPgeEmail() && resource.data.responsavelEmail == request.auth.token.email;
      
      // Updates não permitidos
      allow update: if false;
    }
  }
}
