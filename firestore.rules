rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Verifica se o usuário está autenticado
    function isAuthenticated() {
      return request.auth != null &&
             request.auth.token.email != null;
    }
    
    // Regras para a coleção de salas
    match /salas/{salaId} {
      // Qualquer usuário pode ler as salas (informações públicas)
      allow read: if true;
      
      // Apenas usuários autenticados podem criar/modificar salas
      // TODO: Restringir para apenas administradores no futuro
      allow write: if isAuthenticated();
    }
    
    // Regras para a coleção de reservas
    match /reservas/{reservaId} {
      
      // Apenas usuários autenticados podem LER (para verificar disponibilidade)
      allow read: if isAuthenticated();
      
      // Criar: autenticado + validação de campos
      allow create: if isAuthenticated()
        // Campos obrigatórios (incluindo salaId)
        && request.resource.data.keys().hasAll(['salaId', 'responsavel', 'responsavelEmail', 'data', 'horaInicio', 'horaFim', 'assunto'])
        // Validação do salaId
        && request.resource.data.salaId is string
        && request.resource.data.salaId.size() > 0
        // Email deve ser do usuário autenticado
        && request.resource.data.responsavelEmail == request.auth.token.email
        // Validação do responsavel
        && request.resource.data.responsavel is string
        && request.resource.data.responsavel.size() >= 3
        && request.resource.data.responsavel.size() <= 100
        // Validação do assunto
        && request.resource.data.assunto is string
        && request.resource.data.assunto.size() >= 3 
        && request.resource.data.assunto.size() <= 200
        // Validação da data
        && request.resource.data.data is string
        && request.resource.data.data.matches('\\d{4}-\\d{2}-\\d{2}') // Formato YYYY-MM-DD
        // Validação dos horários
        && request.resource.data.horaInicio is string
        && request.resource.data.horaInicio.matches('\\d{2}:\\d{2}') // Formato HH:MM
        && request.resource.data.horaFim is string
        && request.resource.data.horaFim.matches('\\d{2}:\\d{2}') // Formato HH:MM
        && request.resource.data.horaInicio < request.resource.data.horaFim
        // Validação opcional das observações (se existir)
        && (!request.resource.data.keys().hasAny(['observacoes']) || request.resource.data.observacoes == null || (request.resource.data.observacoes is string && request.resource.data.observacoes.size() <= 500));
      
      // Delete: autenticado + dono da reserva (por email)
      allow delete: if isAuthenticated() && resource.data.responsavelEmail == request.auth.token.email;
      
      // Update: apenas para adicionar salaId em reservas antigas (migração)
      // Permite update se o usuário está autenticado E está apenas adicionando o campo salaId
      allow update: if isAuthenticated() 
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['salaId'])
        && request.resource.data.salaId is string
        && request.resource.data.salaId.size() > 0;
    }
    
    // Regras para logs de segurança (opcional - para auditoria persistente)
    match /security_logs/{logId} {
      // Apenas usuários autenticados podem criar logs
      allow create: if isAuthenticated();
      
      // Apenas admins podem ler logs (adicionar lista de admins futuramente)
      allow read: if false; // Por enquanto bloqueado - configurar admins depois
      
      // Logs não podem ser modificados ou deletados
      allow update, delete: if false;
    }
  }
}
